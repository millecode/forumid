{% extends 'admin/base_admin.html.twig' %}
{% set page_title = page_title|default("Gestions d'agenda") %}

{% block admin_content %}

	{# Flash messages #}
	{% for label, messages in app.flashes %}
		{% for message in messages %}
			<div class="mb-3 rounded-4 p-3 admin-flash admin-flash-{{ label }}">
				{{ message }}
			</div>
		{% endfor %}
	{% endfor %}

	<div
		class="row g-4">

		{# ===== FORM SECTION (TOP) ===== #}
		<div class="col-12" data-reveal="0">
			<div class="card-soft p-4">
				<div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-3">
					<div>
						<div class="fw-extrabold text-slate-900 mb-1">
							{{ is_edit ? 'Modifier un élément agenda' : 'Ajouter un élément agenda' }}
						</div>
						<div class="text-slate-600 small">
							Choisissez une date (EventDate), puis renseignez l’horaire et le contenu.
						</div>
					</div>

					{# Filtre serveur via ?date=ID (bonus UX) #}
					<form method="get" action="{{ path('admin_agenda_index') }}" class="d-flex align-items-center gap-2">
						<select name="date" class="form-select rounded-4" data-agenda-filter>
							<option value="0">Toutes les dates</option>
							{% for d in eventDates %}
								<option value="{{ d.id }}" {{ currentDate and d.id == currentDate.id ? 'selected' : '' }}>
									{{ d.startDate|date('d/m/Y') }}
									→
									{{ d.endDate|date('d/m/Y') }}{{ d.isActive ? ' • Active' : '' }}
								</option>
							{% endfor %}
						</select>
						<noscript>
							<button class="btn btn-emerald">Filtrer</button>
						</noscript>
					</form>
				</div>

				{{ form_start(form, {'attr': {'class': 'row g-3'}}) }}

				<div class="col-12 col-lg-4">
					{{ form_label(form.eventDate, null, {'label_attr': {'class':'form-label fw-bold text-slate-900'}}) }}
					{{ form_widget(form.eventDate, {'attr': {'class':'form-select form-select-lg rounded-4'}}) }}
					<div class="text-danger small mt-1">{{ form_errors(form.eventDate) }}</div>
				</div>

				<div class="col-6 col-lg-4">
					{{ form_label(form.startTime, null, {'label_attr': {'class':'form-label fw-bold text-slate-900'}}) }}
					{{ form_widget(form.startTime, {'attr': {'class':'form-control form-control-lg rounded-4'}}) }}
					<div class="text-danger small mt-1">{{ form_errors(form.startTime) }}</div>
				</div>

				<div class="col-6 col-lg-4">
					{{ form_label(form.endTime, null, {'label_attr': {'class':'form-label fw-bold text-slate-900'}}) }}
					{{ form_widget(form.endTime, {'attr': {'class':'form-control form-control-lg rounded-4'}}) }}
					<div class="text-danger small mt-1">{{ form_errors(form.endTime) }}</div>
				</div>

				<div class="col-12 col-lg-4">
					{{ form_label(form.category, null, {'label_attr': {'class':'form-label fw-bold text-slate-900'}}) }}
					{{ form_widget(form.category, {'attr': {'class':'form-select form-select-lg rounded-4'}}) }}
					<div class="text-danger small mt-1">{{ form_errors(form.category) }}</div>
				</div>

				<div class="col-12 col-lg-8">
					{{ form_label(form.title, null, {'label_attr': {'class':'form-label fw-bold text-slate-900'}}) }}
					{{ form_widget(form.title, {'attr': {'class':'form-control form-control-lg rounded-4'}}) }}
					<div class="text-danger small mt-1">{{ form_errors(form.title) }}</div>
				</div>

				<div class="col-12">
					{{ form_label(form.description, null, {'label_attr': {'class':'form-label fw-bold text-slate-900'}}) }}
					{{ form_widget(form.description, {'attr': {'class':'form-control rounded-4', 'rows': 4}}) }}
					<div class="text-danger small mt-1">{{ form_errors(form.description) }}</div>
				</div>

				<div class="col-12 d-flex flex-wrap gap-2 pt-2">
					<button type="submit" class="btn site-btn-inscription px-4">
						{{ is_edit ? 'Modifier' : 'Ajouter' }}
					</button>

					{% if is_edit %}
						<a href="{{ path('admin_agenda_index', currentDate ? {'date': currentDate.id} : {}) }}" class="btn btn-glass px-4">
							Annuler
						</a>
					{% endif %}
				</div>

				{{ form_end(form) }}
			</div>
		</div>

		{# ===== LIST SECTION (CARDS) ===== #}
		<div class="col-12" data-reveal="120">
			<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
				<div class="fw-extrabold text-slate-900">Liste des éléments</div>
				{% if currentDate %}
					<span class="badge-soft-emerald2">
						{{ currentDate.startDate|date('d/m/Y') }}
						→
						{{ currentDate.endDate|date('d/m/Y') }}{{ currentDate.isActive ? ' • Active' : '' }}
					</span>
				{% endif %}
			</div>

			{% if agendas is empty %}
				<div class="card-soft p-4">
					<div class="text-slate-600">Aucun élément agenda pour cette date.</div>
				</div>
			{% else %}
				<div class="row g-4">
					{% for item in agendas %}
						<div class="col-12 col-md-6 col-xl-4">
							<div class="card-soft p-4 hover-lift agenda-card h-100">
								<div class="d-flex align-items-start justify-content-between gap-3">
									<div>
										<div class="d-flex flex-wrap align-items-center gap-2 mb-2">
											<span class="badge-soft-emerald2">
												{{ item.startTime|date('H:i') }}
												→
												{{ item.endTime|date('H:i') }}
											</span>

											<span class="agenda-badge">{{ item.category }}</span>
										</div>

										<div class="fw-extrabold text-slate-900">{{ item.title }}</div>
									</div>

									<div class="d-flex align-items-center gap-2">
										<a href="{{ path('admin_agenda_edit', {'id': item.id}) }}" class="btn btn-sm admin-icon-action" title="Modifier">
											<svg width="18" height="18" viewbox="0 0 24 24" fill="none" aria-hidden="true">
												<path d="M12 20h9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
												<path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L8 18l-4 1 1-4 11.5-11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
											</svg>
										</a>

										<form method="post" action="{{ path('admin_agenda_delete', {'id': item.id}) }}" onsubmit="return confirm('Supprimer cet élément ?');">
											<input type="hidden" name="_token" value="{{ csrf_token('delete_agenda_' ~ item.id) }}">
											<button type="submit" class="btn btn-sm admin-icon-action admin-icon-danger" title="Supprimer">
												<svg width="18" height="18" viewbox="0 0 24 24" fill="none" aria-hidden="true">
													<path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
													<path d="M8 6V4h8v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
													<path d="M19 6l-1 14H6L5 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
													<path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
												</svg>
											</button>
										</form>
									</div>
								</div>

								{% if item.description %}
									<p class="text-slate-600 mt-3 mb-0" style="line-height:1.7;">
										{{ item.description }}
									</p>
								{% else %}
									<p class="text-slate-600 mt-3 mb-0 small">—</p>
								{% endif %}

								<div class="mt-3 small text-slate-600">
									EventDate :
									{{ item.eventDate.startDate|date('d/m/Y') }}
									→
									{{ item.eventDate.endDate|date('d/m/Y') }}
								</div>
							</div>
						</div>
					{% endfor %}
				</div>
			{% endif %}
		</div>

	</div>

{% endblock %}
